# =============================================================================
# Automated Code Review Workflow
# =============================================================================
# Runs on pull requests and pushes to ensure code quality, security,
# and consistency across the repository.
# =============================================================================

name: Code Review

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  # ---------------------------------------------------------------------------
  # YAML Linting (docker-compose, GitHub Actions)
  # ---------------------------------------------------------------------------
  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run yamllint
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: .
          config_file: .yamllint.yml
          strict: false

  # ---------------------------------------------------------------------------
  # JSON Validation
  # ---------------------------------------------------------------------------
  json-validate:
    name: JSON Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate JSON files
        run: |
          echo "Validating JSON files..."
          find . -name "*.json" -type f | while read file; do
            echo "Checking: $file"
            python3 -m json.tool "$file" > /dev/null || exit 1
          done
          echo "All JSON files are valid!"

  # ---------------------------------------------------------------------------
  # Docker Compose Validation
  # ---------------------------------------------------------------------------
  docker-compose-validate:
    name: Docker Compose Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate docker-compose files
        run: |
          echo "Validating Docker Compose files..."

          # Check root docker-compose.yml
          if [ -f "docker-compose.yml" ]; then
            echo "Checking: docker-compose.yml"
            docker compose -f docker-compose.yml config --quiet
          fi

          # Check CasaOS app store compose files
          find casaos-appstore -name "docker-compose.yml" -type f 2>/dev/null | while read file; do
            echo "Checking: $file"
            docker compose -f "$file" config --quiet || echo "Warning: $file may use CasaOS-specific variables"
          done

          echo "Docker Compose validation complete!"

  # ---------------------------------------------------------------------------
  # Markdown Linting
  # ---------------------------------------------------------------------------
  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run markdownlint
        uses: DavidAnson/markdownlint-cli2-action@v22
        with:
          config: .markdownlint.json
          globs: |
            **/*.md
            !node_modules

  # ---------------------------------------------------------------------------
  # Security Scanning - Secrets Detection
  # ---------------------------------------------------------------------------
  secrets-scan:
    name: Secrets Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ---------------------------------------------------------------------------
  # Security Scanning - Hadolint (Dockerfile best practices)
  # ---------------------------------------------------------------------------
  hadolint:
    name: Hadolint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find and lint Dockerfiles
        run: |
          # Check if any Dockerfiles exist
          if find . -name "Dockerfile*" -type f | grep -q .; then
            echo "Linting Dockerfiles..."
            find . -name "Dockerfile*" -type f -exec hadolint {} \;
          else
            echo "No Dockerfiles found, skipping..."
          fi
        continue-on-error: true

  # ---------------------------------------------------------------------------
  # Shell Script Linting
  # ---------------------------------------------------------------------------
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run ShellCheck
        run: |
          # Check if any shell scripts exist
          if find . -name "*.sh" -type f | grep -q .; then
            echo "Linting shell scripts..."
            find . -name "*.sh" -type f -exec shellcheck {} \;
          else
            echo "No shell scripts found, skipping..."
          fi
        continue-on-error: true

  # ---------------------------------------------------------------------------
  # License Check
  # ---------------------------------------------------------------------------
  license-check:
    name: License Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify LICENSE file exists
        run: |
          if [ ! -f "LICENSE" ]; then
            echo "ERROR: LICENSE file not found!"
            exit 1
          fi
          echo "LICENSE file found"

      - name: Verify license type
        run: |
          if grep -q "GNU AFFERO GENERAL PUBLIC LICENSE" LICENSE; then
            echo "License: AGPL-3.0 ✓"
          else
            echo "WARNING: Expected AGPL-3.0 license"
          fi

  # ---------------------------------------------------------------------------
  # Summary Report
  # ---------------------------------------------------------------------------
  summary:
    name: Review Summary
    runs-on: ubuntu-latest
    needs: [yaml-lint, json-validate, docker-compose-validate, markdown-lint, secrets-scan, license-check]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## Code Review Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| YAML Lint | ${{ needs.yaml-lint.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| JSON Validate | ${{ needs.json-validate.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Compose | ${{ needs.docker-compose-validate.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Markdown Lint | ${{ needs.markdown-lint.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secrets Scan | ${{ needs.secrets-scan.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Check | ${{ needs.license-check.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
