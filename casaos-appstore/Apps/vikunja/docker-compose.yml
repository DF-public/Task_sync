# =============================================================================
# Vikunja - Self-Hosted Task Management for CasaOS
# =============================================================================
# This configuration is designed for the CasaOS app store.
# It deploys Vikunja with MariaDB as a complete task management solution.
# =============================================================================

name: vikunja

services:
  # ---------------------------------------------------------------------------
  # Vikunja Application
  # ---------------------------------------------------------------------------
  vikunja:
    image: vikunja/vikunja:0.24.6
    container_name: vikunja
    restart: unless-stopped
    environment:
      # Database configuration
      VIKUNJA_DATABASE_TYPE: mysql
      VIKUNJA_DATABASE_HOST: vikunja-db
      VIKUNJA_DATABASE_DATABASE: vikunja
      VIKUNJA_DATABASE_USER: vikunja
      VIKUNJA_DATABASE_PASSWORD: vikunja_db_password
      # Service configuration
      VIKUNJA_SERVICE_PUBLICURL: ""
      VIKUNJA_SERVICE_JWTSECRET: change-me-to-a-random-secret-string
      VIKUNJA_SERVICE_ENABLEREGISTRATION: "true"
      # Timezone
      TZ: $TZ
    ports:
      - target: 3456
        published: $WEBUI_PORT
        protocol: tcp
    volumes:
      - type: bind
        source: /DATA/AppData/$AppID/files
        target: /app/vikunja/files
    networks:
      - vikunja-network
    depends_on:
      vikunja-db:
        condition: service_healthy
    deploy:
      resources:
        reservations:
          memory: 128M
    x-casaos:
      envs:
        - container: VIKUNJA_SERVICE_PUBLICURL
          description:
            en_us: "Public URL where Vikunja is accessible (e.g., http://your-ip:3456)"
        - container: VIKUNJA_SERVICE_JWTSECRET
          description:
            en_us: "JWT secret for authentication (change this to a random string!)"
        - container: VIKUNJA_SERVICE_ENABLEREGISTRATION
          description:
            en_us: "Allow new user registration (set to false after initial setup)"
        - container: VIKUNJA_DATABASE_PASSWORD
          description:
            en_us: "Database password (must match the database service password)"
        - container: TZ
          description:
            en_us: "Timezone for the application"
      ports:
        - container: "3456"
          description:
            en_us: "Vikunja Web UI Port"
      volumes:
        - container: /app/vikunja/files
          description:
            en_us: "Vikunja files storage (attachments, avatars)"

  # ---------------------------------------------------------------------------
  # MariaDB Database
  # ---------------------------------------------------------------------------
  vikunja-db:
    image: mariadb:10.11
    container_name: vikunja-db
    restart: unless-stopped
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
    environment:
      MYSQL_ROOT_PASSWORD: vikunja_root_password
      MYSQL_DATABASE: vikunja
      MYSQL_USER: vikunja
      MYSQL_PASSWORD: vikunja_db_password
      TZ: $TZ
    volumes:
      - type: bind
        source: /DATA/AppData/$AppID/database
        target: /var/lib/mysql
    networks:
      - vikunja-network
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        reservations:
          memory: 256M
    x-casaos:
      envs:
        - container: MYSQL_ROOT_PASSWORD
          description:
            en_us: "MariaDB root password"
        - container: MYSQL_PASSWORD
          description:
            en_us: "Database password for Vikunja user (must match app password)"
        - container: TZ
          description:
            en_us: "Timezone for the database"
      volumes:
        - container: /var/lib/mysql
          description:
            en_us: "MariaDB data storage"

networks:
  vikunja-network:
    name: vikunja-network
    driver: bridge

# =============================================================================
# CasaOS App Store Metadata
# =============================================================================
x-casaos:
  architectures:
    - amd64
    - arm64
  main: vikunja
  author: DF_public
  category: Utilities
  description:
    en_us: |
      Vikunja is an open-source, self-hosted task management application.

      This installation includes:
      - Vikunja task manager with web UI
      - MariaDB database for data persistence
      - Pre-configured networking between services

      Perfect for:
      - Personal task management
      - Team collaboration
      - Project organization
      - Integration with external systems via API

      After installation, access the web interface and create your first account.
      For security, disable registration after creating your account.
  developer: Vikunja Team
  icon: https://vikunja.io/images/vikunja-logo.svg
  index: /
  port_map: "3456"
  scheme: http
  tagline:
    en_us: Self-hosted task management made simple
  thumbnail: https://vikunja.io/images/vikunja-logo.svg
  tips:
    before_install:
      en_us: |
        **Important Security Notes:**

        1. After installation, change the following default passwords:
           - `VIKUNJA_SERVICE_JWTSECRET` - Generate with: `openssl rand -base64 32`
           - `MYSQL_ROOT_PASSWORD` - Choose a strong password
           - `MYSQL_PASSWORD` / `VIKUNJA_DATABASE_PASSWORD` - Must match each other

        2. Set `VIKUNJA_SERVICE_PUBLICURL` to your actual access URL

        3. After creating your account, set `VIKUNJA_SERVICE_ENABLEREGISTRATION` to `false`
  title:
    en_us: Vikunja
